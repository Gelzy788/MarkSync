<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script>
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = event => {
                    console.log("–î–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω—ã:", event.data); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstart = () => {
                    console.log("–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å."); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
                };

                mediaRecorder.onstop = async () => {
                    console.log("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞."); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log("–°–æ–∑–¥–∞–Ω Blob –∞—É–¥–∏–æ:", audioBlob); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
                    audioChunks = []; // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                    uploadAudio(audioBlob);
                };

                mediaRecorder.start();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", error);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.");
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            } else {
                console.error("–ó–∞–ø–∏—Å—å –Ω–µ –±—ã–ª–∞ –Ω–∞—á–∞—Ç–∞.");
            }
        }

        async function uploadAudio(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob, "recording.webm");

            for (let pair of formData.entries()) {
                console.log(pair[0], pair[1]);  // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω
            }

            try {
                const response = await fetch('/record_voice_message', {
                    method: "POST",
                    body: formData  // ‚úÖ –ù–ï –¥–æ–±–∞–≤–ª—è–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ Content-Type –≤—Ä—É—á–Ω—É—é!
                });

                const result = await response.json();
                console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç:", result);
                document.getElementById('transcription').innerText = result.transcription || '–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏';
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
                document.getElementById('transcription').innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞.';
            }
        }
    </script>
</head>
<body>
    <h1>{{ title }}</h1>
    <button onclick="startRecording()">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button onclick="stopRecording()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>

    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:</h2>
    <p id="transcription">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç...</p>
</body>
</html>